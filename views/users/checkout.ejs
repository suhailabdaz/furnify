<!-- /*
* Bootstrap 5
* Template Name: Furni
* Template Author: Untree.co
* Template URI: https://untree.co/
* License: https://creativecommons.org/licenses/by/3.0/
*/ -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="author" content="Untree.co">
  <link rel="shortcut icon" href="favicon.png">

  <meta name="description" content="" />
  <meta name="keywords" content="bootstrap, bootstrap4" />
  <style>

/* The Modal (background) */
.modal {
  display: none; /* Hidden by default */
  position: fixed;
  top: 0;
  left: 0;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
}

/* Modal Content */
.modal-content {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(0, -50%);
  background-color: #3e6e5c;
  color: rgb(0, 0, 0);
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

/* Close button */
.close {
  top: 0;
  right: 0;
  padding: 10px;
  cursor: pointer;
}

/* Style the button inside the modal */
.modal-content button {
  background-color: #000000; /* Green background */
  color: white; /* White text */
  padding: 5px;
  border: none;
  border-radius: 8px;
  margin-left: 2px;
  cursor: pointer;

}

/* Hover effect for the button */
.modal-content button:hover {
  background-color: #fbfdfb;
  color: #000000;
  border: solid 2px #000000;
}

	 .address-list {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .address-item {
            width: 48%; /* Two items in one row with a small gap */
            padding: 10px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }

        .address-details {
            display: none;
            padding-left: 20px;
        }

        .larger-text {
            font-size: 16px; 

        }

        
    .category-options {
      display: none;
    }
    .search-bar {
      background-color: #3b5d50;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 35px;
      margin: 0;
      display: flex;
      border: 2px solid #efeeee;
      border-radius: 30px;
      overflow: hidden;
    }

    .search-input {
      border: none;
      padding: 10px;
      width: 800px;
      background-color: #3b5d50;
      color: white;
    }

    .search-button {
      background-color: #3d5d50;
      color: white;
      border: none;
      padding: 10px;
      border-top-right-radius: 20px;
      border-bottom-right-radius: 20px;
      cursor: pointer;
    }
	.key{
		color: #3b5d50;
		font-weight: bold;
	}
  </style>

		<!-- Bootstrap CSS -->
		<link href="css/bootstrap.min.css" rel="stylesheet">
		<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
		<link href="css/tiny-slider.css" rel="stylesheet">
		<link href="css/style.css" rel="stylesheet">
		<title>Checkout</title>
	</head>

	<body>

		<!-- Start Header/Navigation -->
        <%-include('userpartials/nav')%>
		<!-- Start Hero Section -->
			<div class="hero">
				<div class="container">
					<div class="row justify-content-between">
						<div class="col-lg-5">
							<div class="intro-excerpt">
								<h1>Checkout</h1>
							</div>
						</div>
						<div class="col-lg-7">
							
						</div>
					</div>
				</div>
			</div>
		<!-- End Hero Section -->

		<div class="untree_co-section">
		    <div class="container">
		      <div class="row mb-5">
		        <div class="col-md-12">
		        </div>
		      </div>
		      <div class="row">
		        <div class="col-md-6 mb-5 mb-md-0">
		          <h2 class="h3 mb-3 text-black">Select Address</h2>
		          <div class="p-3 p-lg-5 border bg-white">
		            

					<% if (addresses && addresses.length > 0) { %>
						<div class="address-list">
							<% addresses.forEach(address => { %>
								<div class="address-item">
									<label>
										<!-- Add a data attribute to the radio button to store the address ID -->
                                    <input type="radio" name="selectedAddress" value="<%= address.id %>" class="address-radio" data-address-id="<%= address.id %>">

										<span class="larger-text"><%= address.saveas %></span>
									</label>
									<div class="address-details larger-text">
										<p><span class="key">Full Name: </span><%= address.fullname %></p>
										<p><span class="key">House name/Flat no:</span><%= address.adname %></p>
										<p><span class="key">Street:</span> <%= address.street %></p>
										<p><span class="key">City:</span> <%= address.city %></p>
										<p><span class="key">Pin-Code:</span><%= address.pincode %></p>
										<p><span class="key">State:</span><%= address.state %></p>
										<p><span class="key">Country:</span> <%= address.country %></p>
										<!-- Add other address properties as needed -->
									</div>
								</div>
							<% }); %>
						</div>
					<% } else { %>
						<p>No addresses found.</p>
					<% } %>
					
				
		        


		            

		          

		           




		            <div class="form-group">

		              <label for="c_ship_different_address" class="text-black" data-bs-toggle="collapse" href="#ship_different_address" role="button" aria-expanded="false" aria-controls="ship_different_address"><input type="checkbox" value="1" id="c_ship_different_address">Add a new Address</label>
		              <div class="collapse" id="ship_different_address">
						<div class="suso container mt-4">
							<div class="edit-profile-form">
								
								
							  <h2>Add New Address</h2>
							  
							  <p style="font-weight: 600; color: red;">!! The Address May not be saved if you enter invalid details </p>
							
							
							
							
							
							
			
							  
						  
							  <form action="/checkoutreload" id="addressForm" method="post" class="row">
							 
								<!-- Personal details -->
						
								<div class="form-group col-md-6">
									<label for="saveas">Save as</label>
									<input type="text" id="saveas" name="saveas" class="form-control">
								  </div>
								<div class="form-group col-md-6">
								  <label for="fullname">Full Name</label>
								  <input type="text" id="fullname" name="fullname" class="form-control">
								</div>
						  
								<div class="form-group col-md-6">
								  <label for="adname">House Name / Flat No</label>
								  <input type="text" id="adname" name="adname" class="form-control">
								</div>
						  
								<div class="form-group col-md-6">
								  <label for="street">Street</label>
								  <input type="text" id="street" name="street" class="form-control">
								</div>
						  
								<div class="form-group col-md-6">
								  <label for="pincode">Pincode</label>
								  <input type="number" id="pincode" name="pincode" class="form-control">
								</div>
						  
								<div class="form-group col-md-6">
								  <label for="city">City</label>
								  <input type="text" id="city" name="city" class="form-control">
								</div>
						  
								<div class="form-group col-md-6">
									<label for="state">State</label>
									<select id="state" name="state" class="form-control" required>
									  <option value="" disabled selected>Select a state</option>
									  <option value="Kerala">Kerala</option>
									  <option value="Karnataka">Karnataka</option>
									  <option value="TamilNadu">Tamil Nadu</option>
									</select>
								  </div>
						  
								  <div class="form-group col-md-6">
									<label for="country">Country</label>
									<select id="country" name="country" class="form-control" required>
									  <option value="India">India</option>
									</select>
								  </div>
								  
						  
								<div class="form-group col-md-6">
								  <label for="phone">Phone Number</label>
								  <input type="number" id="phone" name="phone" class="form-control">
								</div>

								<input type="hidden" name="cartId" value="<%= cart._id %>">
						  
								<div class="form-group col-12">
								  <button id="saveChangesButton" type="submit" class="btn btn-primary">Save Changes</button>
								</div>
							  </form>
							
							  
							</div>
						  </div>

		              </div>
		            </div>

		          </div>
		        </div>
		        <div class="col-md-6">

		          <div class="row mb-5">
		            <div class="col-md-12">
		              <h2 class="h3 mb-3 text-black">Coupon Code</h2>
		              <div class="p-3 p-lg-5 border bg-white">
						<!-- Add a button to open the modal -->
<button onclick="openModal()"><h2>Available Coupons</h2></button>

<!-- The Modal -->
<div id="couponModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <ul>
      <% availableCoupons.forEach(coupon => { %>
        <li>
			<div class="row">
			<div class="col-3">
				<%= coupon.couponCode %> &nbsp;&nbsp;
				<% if (coupon.type === "percentageDiscount") { %>
				  <p><%= coupon.discount %>% off on Rs.<%= coupon.minimumPrice %> purchase (Maximum Redeemable: <%= coupon.maxRedeem %>)</p><br>
				<% } else { %>
				  <p> Flat Rs. <%= coupon.discount %>% off on <%= coupon.minimumPrice %> purchase</p><br>
				<% } %>
			  </div>
			  <div class="col-3 mt-2 ">
				<button onclick="copyToClipboard('<%= coupon.couponCode %>')">Copy Code</button>
			  </div>
			</div>
        </li>
      <% }); %>
    </ul>
  </div>
</div>
						
                        <form>
		                <label for="c_code" class="text-black mb-3">Enter your coupon code if you have one</label>
		                <div class="input-group w-75 couponcode-wrap">
		                  <input type="text" class="form-control me-2" id="c_code" placeholder="Coupon Code" aria-label="Coupon Code" aria-describedby="button-addon2">
		                  <div class="input-group-append">
		                    <button class="btn btn-black btn-sm" type="button" id="button-addon2" onclick="couponApply()">Apply</button>
		                  </div>
						  <div >
		                    <button style="color: black;border: solid black;margin-left: 3px;" class="btn btn-white-outline btn-sm" type="button" id="button-addon3" onclick="couponRevoke()">Clear</button>
		                  </div>
		                </div>
					</form>

		              </div>
		            </div>
		          </div>

		          <div class="row mb-5">
		            <div class="col-md-12">
		              <h2 class="h3 mb-3 text-black">Your Order</h2>
		              <div class="p-3 p-lg-5 border bg-white">
		                <table class="table site-block-order-table mb-5">
		                  <thead>
		                    <th>Product</th>
							<th>Price&nbsp&&nbspQty</th>
		                    <th>Total</th>
		                  </thead>
		                  <tbody>
                            <% cartItems.forEach(cartItem => { %>
							<tr>
                                <td ><span id="productname"><%= cartItem.productName %></span></td>
								<td id="itemprice"><%= cartItem.price %><strong class="mx-2">x</strong><span id="itemquantity"> <%= cartItem.quantity %></span></td>

                                <td id="itemtotal"><%= cartItem.itemTotal %></td>
                                </tr>
                            <% }); %>
		                    <tr>
		                      <td class="text-black font-weight-bold"><strong>Cart Subtotal</strong></td>
							  <td></td>
							  
		                      <td id="subt" style="font-weight: 700;"><%= cart.total %></td>
		                    </tr>
							<tr>
								<td class="text-black font-weight-bold"><strong>Discount Amount</strong></td>
								<td></td>
								<td id="dicprice" style="color: green; font-weight: 500;">0</td>
							</tr>
		                    <tr>
		                    <td class="text-black font-weight-bold"><strong>Order Total</strong></td>
							  <td></td>
		                      <td id="cartotal" style="font-weight: 700;"><strong><mark>
								<%= cart.total %></mark></strong></td>
		                    </tr>
						
		                  </tbody>
		                </table>

		                <form  id="orderForm">
							<label>
							  <input type="radio" name="paymentOption" value="Cash On Delivery" id="paymentOption1" onchange="updateHiddenField(this)">
							 Cash On Delivery
							</label><br>
						
							<label>
							  <input type="radio" name="paymentOption" value="Razorpay" id="paymentOption2" onchange="updateHiddenField(this)">
							  Razorpay
							</label><br>

							<label>
								<input type="radio" name="paymentOption" value="Wallet" id="paymentOption3" onchange="updateHiddenField(this)">
							  Wallet
							  </label><br><br>
						
							
							
						
							<!-- Hidden input fields for address details -->
							<input type="hidden" name="selectedAddressId" id="selectedAddressId" value="<%= addresses.length > 0 ? addresses[0].id : '' %>">
							<!-- Add other hidden fields for additional address properties as needed -->
							<% cartItems.forEach(cartItem => { %>
							<!-- Hidden input fields for cart item details -->
							<input type="hidden" name="selectedProductIds[]" class="selectedProductIds[]" value="<%= cartItem.productId ? cartItem.productId.toString() : '' %>">

							<input type="hidden" name="selectedProductNames[]" class="selectedProductNames[]" value="<%= cartItem.productName %>">
							<input type="hidden" name="selectedProductPrices[]" class="selectedProductPrices[]" value="<%= cartItem.price %>">

							<input type="hidden" name="selectedQuantities[]" class="selectedQuantities[]" value="<%= cartItem.quantity %>">
							<input type="hidden" name="selectedCartTotals[]" class="selectedCartTotals[]" value="<%= cartItem.itemTotal %>">
							<!-- Add other hidden fields for additional cart item properties as needed -->
							<% }); %>
							<input type="hidden" name="carttotal" class="carttotal" id="carttotal"value="<%= cart.total %>">
							<input type="hidden" name="selectedPaymentOption" id="selectedPaymentOption">
							
							<input type="hidden" name="cartId" value="<%= cart._id %>">

							<div class="form-group">
							<button class="btn btn-black btn-lg py-3 btn-block" type="button" onclick="razorpay()">Place Order</button>
							</div>
						</form>
		

	</div>
		            </div>
		          </div>

		        </div>
		      </div>
			
		    </div>
		  </div>

		<!-- Start Footer Section -->
		<%-include('userpartials/footer')%>
		
		<!-- End Footer Section -->	
		<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
		<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

		<script>
			function openModal() {
			  var modal = document.getElementById('couponModal');
			  modal.style.display = 'block';
			}
		  
			function closeModal() {
			  var modal = document.getElementById('couponModal');
			  modal.style.display = 'none';
			}
		  
			function copyToClipboard(couponCode) {
			  var tempInput = document.createElement('input');
			  tempInput.value = couponCode;
			  document.body.appendChild(tempInput);
		  
			  tempInput.select();
			  document.execCommand('copy');
		  
			  document.body.removeChild(tempInput);
		  
			  alert('Coupon code copied to clipboard: ' + couponCode);
			}
		  
			document.addEventListener('DOMContentLoaded', function () {
			  // Close the modal if the user clicks outside of it
			  window.addEventListener('click', function (event) {
				var modal = document.getElementById('couponModal');
				if (event.target === modal) {
				  closeModal();
				}
			  });
			});
		  </script>
		  
		<script>
			function toggleDropdown() {
			  var dropdownContent = document.querySelector('.dropdown-content');
			  dropdownContent.style.display = dropdownContent.style.display === 'block' ? 'none' : 'block';
			}
		  </script>
<script>
			$(document).ready(function () {
				$('.address-radio').change(function () {
					var selectedAddressId = $(this).data('address-id');
					$('#selectedAddressId').val(selectedAddressId)
					$('.address-details').slideUp();
					$(this).closest('.address-item').find('.address-details').slideDown();
				});
			});
			function updateHiddenField(selectedRadio) {
            document.getElementById('selectedPaymentOption').value = selectedRadio.value;
			}
			</script>
			<script>
	async function  razorpay()
	{
		let amountToPay=document.getElementById('cartotal').innerText
		var pay=document.querySelector('input[name="paymentOption"]:checked');
		var addressTo=document.querySelector('input[name="selectedAddress"]:checked');


		if(!pay){
			Swal.fire({
//   title: 'Error!',
  text: 'please select a payment option',
  icon: 'error',
  confirmButtonText: 'OK',
  customClass: {
    title: 'text-danger',
    popup: 'swal2-popup-custom',
    confirmButton: 'btn btn-danger'
  },
  showCancelButton: false,
  showCloseButton: true,
  showLoaderOnConfirm: false,
  timer: 3000 
});

		}
		else if(!addressTo){
			Swal.fire({
  text: 'please select an address',
  icon: 'error',
  confirmButtonText: 'OK',
  customClass: {
    title: 'text-danger',
    popup: 'swal2-popup-custom',
    confirmButton: 'btn btn-danger'
  },
  showCancelButton: false,
  showCloseButton: true,
  showLoaderOnConfirm: false,
  timer: 3000 
});

		}
		
		else if(pay.value=='Razorpay'){
console.log("upi total","ppppppp");

var options = {
"key": 'rzp_test_tY3tynQ51qUYZR', 
"amount":  amountToPay*100, 
"name": "Furnify",
"description": "Test Transaction",
"image": "Urban Sole",
"order_id": orderId, 
"handler": function (response){
alert(response.razorpay_payment_id);
document.getElementById('orderForm').action = '/placeOrder';
document.getElementById('orderForm').method = 'post'; 

// Submit the form
document.getElementById('orderForm').submit();

},


"theme": {
"color": "orange"
},
};
var rzp1 = new Razorpay(options);
rzp1.on('payment.failed', function (response){
        alert(response.error.code);
        alert(response.error.description);
        alert(response.error.source);
        alert(response.error.step);
        alert(response.error.reason);
        alert(response.error.metadata.order_id);
        alert(response.error.metadata.payment_id);
});
    rzp1.open();


    e.preventDefault();


                var orderId ;
$(document).ready(function(){
    var settings = {
  "url": "/create/orderId",
  "method": "POST",
  "timeout": 0,
  "headers": {
    "Content-Type": "application/json"
  },
  "data": JSON.stringify({
    "amount": amountToPay*100
  }),
};
;

$.ajax(settings).done(function (response) {

  orderId=response.orderId;
  console.log(orderId);
  $("button").show();
});
});

                
            }
		 else if (pay.value === 'Wallet') {
    console.log("coooococococococ");
    try {
      const response = await fetch('/wallettransaction', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          amount: amountToPay
        })
      });

      const data = await response.json();

      if (data.success) {
        console.log(pay.value, "000000");
        document.getElementById('orderForm').action = '/placeOrder';
        document.getElementById('orderForm').method = 'post';
        document.getElementById('orderForm').submit();
      } else {
        console.log("cccc");
        Swal.fire({
          text: "You Don't have Enough money in Wallet",
          icon: 'error',
          confirmButtonText: 'OK',
          customClass: {
            title: 'text-danger',
            popup: 'swal2-popup-custom',
            confirmButton: 'btn btn-danger'
          },
          showCancelButton: false,
          showCloseButton: true,
          showLoaderOnConfirm: false,
          timer: 3000
        });
        console.log("came else but....");
      }
    } catch (error) {
      console.error("An error occurred during wallet transaction:", error);
      // Handle the error as needed
    }}
			else{
				console.log("jwDQJWD");
				document.getElementById('orderForm').action = '/placeOrder';
document.getElementById('orderForm').method = 'post'; // Replace with your actual URL

// Submit the form
document.getElementById('orderForm').submit();
			
		}
		}

		</script>
		<script>

function couponApply() {
    const couponCode = document.getElementById('c_code').value;
	const subtotal=document.getElementById('subt').innerText

    fetch('/applyCoupon', {
        method: "POST",
        headers: {
            'Content-Type': "application/json"
        },
		body: JSON.stringify({couponCode,subtotal })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
			console.log("ivideumethi")
			document.getElementById('dicprice').innerText="-"+data.dicprice
           document.getElementById('cartotal').innerText=data.price
		   document.getElementById('carttotal').value=data.price


       
        } else {
			Swal.fire({
          text: data.message,
          icon: 'error',
          confirmButtonText: 'OK',
          customClass: {
            title: 'text-danger',
            popup: 'swal2-popup-custom',
            confirmButton: 'btn btn-danger'
          },
          showCancelButton: false,
          showCloseButton: true,
          showLoaderOnConfirm: false,
          timer: 3000
        });
        }
    })
    .catch(error => {
        console.error('Error applying coupon:', error);
        alert('An error occurred while applying the coupon. Please try again.');
    });
}

    function couponRevoke() {
        
		const couponCode = document.getElementById('c_code').value;
	const subtotal=document.getElementById('subt').innerText

    fetch('/revokeCoupon', {
        method: "POST",
        headers: {
            'Content-Type': "application/json"
        },
		body: JSON.stringify({couponCode,subtotal })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
			document.getElementById('dicprice').innerText=0
           document.getElementById('cartotal').innerText=data.price
		   document.getElementById('carttotal').value=data.price


       
        } else {
			Swal.fire({
          text: data.message,
          icon: 'error',
          confirmButtonText: 'OK',
          customClass: {
            title: 'text-danger',
            popup: 'swal2-popup-custom',
            confirmButton: 'btn btn-danger'
          },
          showCancelButton: false,
          showCloseButton: true,
          showLoaderOnConfirm: false,
          timer: 3000
        });
        }
    })
    .catch(error => {
        console.error('Error applying coupon:', error);
        alert('An error occurred while applying the coupon. Please try again.');
    });
    }


		</script>
		
   


	

		<script src="js/bootstrap.bundle.min.js"></script>
		<script src="js/tiny-slider.js"></script>
		<script src="js/custom.js"></script>
	</body>

</html>
